"use strict";exports.id=17,exports.ids=[17],exports.modules={5017:(e,a,t)=>{t.r(a),t.d(a,{$$ACTION_0:()=>m,$$ACTION_1:()=>b,$$ACTION_2:()=>h,$$ACTION_3:()=>g,$$ACTION_4:()=>$,$$ACTION_5:()=>A,createDwollaTransfer:()=>k,createDwollaTransferAuthorization:()=>w,getAccount:()=>I,getAccounts:()=>f,getInstitution:()=>y,getTransactions:()=>p});var n=t(71577);t(90710);var r=t(28600),c=t(24510),d=t(35978),i=t(5955),o=t(22470),s=t(93205);let u=e=>({id:e.id,name:e.name,amount:e.amount,date:e.date,paymentChannel:e.paymentChannel,category:e.category,type:e.type||e.direction}),l=e=>{let a=e.shareableId||e.sharaebleId,t=e.accountId||a||e.$id,n=t?t.slice(-4):"0000";return{id:e.accountId||e.$id,availableBalance:0,currentBalance:0,institutionId:e.bankId||"manual",name:`Manual Account ${n}`,officialName:e.bankId||"Manual Account",mask:n,type:"manual",subtype:"manual",appwriteItemId:e.$id,sharaebleId:a}},f=(0,n.j)("5d9b13c452430c2116f41899ae5e7c77e5903f2f",m);async function m({userId:e}){try{let a=await (0,o.getBanks)({userId:e});if(!(0,d.Pj)()){let e=a?.map(l)??[];return(0,c.fM)({data:e,totalBanks:e.length,totalCurrentBalance:0})}let t=await Promise.all(a?.map(async e=>{let a=await r.z.accountsGet({access_token:e.accessToken}),t=a.data.accounts[0],n=await y({institutionId:a.data.item.institution_id});return{id:t.account_id,availableBalance:t.balances.available,currentBalance:t.balances.current,institutionId:n.institution_id,name:t.name,officialName:t.official_name,mask:t.mask,type:t.type,subtype:t.subtype,appwriteItemId:e.$id,sharaebleId:e.shareableId}})??[]),n=t.length,i=t.reduce((e,a)=>e+a.currentBalance,0);return(0,c.fM)({data:t,totalBanks:n,totalCurrentBalance:i})}catch(e){console.error("An error occurred while getting the accounts:",e)}}let I=(0,n.j)("47b2bd3deec85f90725d203589068ee558f0daec",b);async function b({appwriteItemId:e}){try{let a=await (0,o.getBank)({documentId:e}),t=(await (0,i.getTransactionsByBankId)({bankId:a.$id})).documents.map(u).sort((e,a)=>new Date(a.date).getTime()-new Date(e.date).getTime());if(!(0,d.Pj)()){let e=l(a);return(0,c.fM)({data:e,transactions:t})}let n=await r.z.accountsGet({access_token:a.accessToken}),s=n.data.accounts[0],f="string"==typeof a.userId?a.userId:a.userId?.$id,m=await p({accessToken:a?.accessToken});f&&await (0,i.upsertPlaidTransactions)(a.$id,f,m.map(e=>({name:e.name,amount:e.amount,date:e.date,category:e.category,paymentChannel:e.paymentChannel,externalId:e.id,status:e.pending?"pending":"posted",accountId:e.accountId})));let I=await y({institutionId:n.data.item.institution_id}),b={id:s.account_id,availableBalance:s.balances.available,currentBalance:s.balances.current,institutionId:I.institution_id,name:s.name,officialName:s.official_name,mask:s.mask,type:s.type,subtype:s.subtype,appwriteItemId:a.$id};return(0,c.fM)({data:b,transactions:t})}catch(e){console.error("An error occurred while getting the account:",e)}}let y=(0,n.j)("62b1579a79fc80688516f02bee5faf4e67b8626b",h);async function h({institutionId:e}){try{let a=(await r.z.institutionsGetById({institution_id:e,country_codes:["US"]})).data.institution;return(0,c.fM)(a)}catch(e){console.error("An error occurred while getting the accounts:",e)}}let p=(0,n.j)("0ea2a069a4ae02ee656a8d04f926531cabf5e515",g);async function g({accessToken:e}){let a;if(!(0,d.Pj)())return[];let t=!0,n=[];try{for(;t;){let c=await r.z.transactionsSync({access_token:e,cursor:a});n.push(...c.data.added),a=c.data.next_cursor||void 0,t=c.data.has_more}return(0,c.fM)(n.map(e=>{let a=e.amount>=0?"debit":"credit",t="debit"===a?-Math.abs(e.amount):Math.abs(e.amount);return{id:e.transaction_id,name:e.name,paymentChannel:e.payment_channel,type:a,accountId:e.account_id,amount:t,pending:e.pending,category:e.category?e.category[0]:"Uncategorized",date:e.date,image:e.logo_url}}))}catch(e){console.error("An error occurred while getting the accounts:",e)}}let w=(0,n.j)("a00f29882350d12eb715b2c97c688bf178f3a265",$);async function $(e){try{let a=await r.z.transferAuthorizationCreate(e);return(0,c.fM)(a.data)}catch(e){console.error("An error occurred during transfer authorization:",e)}}let k=(0,n.j)("9c922bb8b792637990b2e912c8747386564735f2",A);async function A(e){try{let a=await r.z.transferCreate(e);return(0,c.fM)(a.data)}catch(e){console.error("An error occurred while creating the transfer:",e)}}(0,s.h)([f,I,y,p,w,k]),(0,n.j)("2aa8abf8feb5dff0467adb381af78c3122b76343",f),(0,n.j)("efbaedd084a057ed53b6db24520d5cced59f8750",I),(0,n.j)("dd9e1565a30750080024d3474ea81be5f7e30733",y),(0,n.j)("da59215fd48df9f708cff01472c3a7e97bb6a1e3",p),(0,n.j)("1096e16edfb9754e43ac41fed68c9fe0357a5321",w),(0,n.j)("fa93256e0f01fe6d508bec29af9ce93b59056a11",k)},5955:(e,a,t)=>{t.r(a),t.d(a,{$$ACTION_0:()=>w,$$ACTION_1:()=>k,$$ACTION_2:()=>B,$$ACTION_3:()=>_,createManualTransaction:()=>A,createTransaction:()=>g,getTransactionsByBankId:()=>$,upsertPlaidTransactions:()=>T});var n=t(71577);t(90710);var r=t(31438),c=t(12712),d=t(97793),i=t(24510),o=t(22470),s=t(93205);let{APPWRITE_DATABASE_ID:u,APPWRITE_TRANSACTION_COLLECTION_ID:l}=process.env,f=["/","/transaction-history","/statements"],m=e=>Object.fromEntries(Object.entries(e).filter(([,e])=>null!=e&&""!==e)),I=(e,a)=>{let t="number"==typeof e?e:Number(e);if(Number.isNaN(t))throw Error("Invalid amount supplied for transaction");return"debit"===a?t>0?-t:t:"credit"===a?Math.abs(t):t},b=(e,a)=>a||(e<0?"debit":"credit"),y=async()=>{try{let{database:e}=await (0,d.createSessionClient)();return e}catch(a){let{database:e}=await (0,d.createAdminClient)();return e}},h=e=>{let a="number"==typeof e.amount?e.amount:Number(e.amount),t=e.direction||e.type||b(a);return{id:e.externalId||e.$id,$id:e.$id,bankId:e.bankId||e.senderBankId||e.receiverBankId,name:e.name,paymentChannel:e.paymentChannel||e.channel||"online",direction:t,type:t,accountId:e.accountId,amount:Number.isNaN(a)?0:a,pending:e.status?"posted"!==e.status:e.pending,category:e.category||"Transfer",date:e.date||e.$createdAt,image:e.image,status:e.status||(e.pending?"pending":"posted"),source:e.source,externalId:e.externalId,notes:e.notes,$createdAt:e.$createdAt,channel:e.channel,senderBankId:e.senderBankId,receiverBankId:e.receiverBankId}},p=async e=>{let{database:a}=await (0,d.createAdminClient)(),t=e.externalId;if(t){let n=await a.listDocuments(u,l,[r.Query.equal("externalId",[t])]);if(n.total>0){let t=n.documents[0],r=await a.updateDocument(u,l,t.$id,m(e));return(0,i.fM)(r)}}let n=await a.createDocument(u,l,r.ID.unique(),m(e));return(0,i.fM)(n)},g=(0,n.j)("80a709ce214cb135ebc8fe86370fa62d696d6912",w);async function w(e){try{let a=I(e.amount,e.direction),t=b(a,e.direction),n=e.bankId||e.senderBankId||e.receiverBankId,r=m({name:e.name,amount:a,direction:t,type:t,category:e.category||"Transfer",paymentChannel:e.paymentChannel||e.channel||"online",channel:e.channel||e.paymentChannel||"online",status:e.status||"posted",source:e.source||"transfer",date:e.date||new Date().toISOString(),bankId:n,accountId:e.accountId,senderId:e.senderId,receiverId:e.receiverId,senderBankId:e.senderBankId||n,receiverBankId:e.receiverBankId||n,email:e.email,userId:e.userId,externalId:e.externalId,notes:e.notes,metadata:e.metadata});return await p(r)}catch(e){throw console.log(e),e}}let $=(0,n.j)("caff1ac64ec0acb8c5e38bfb005fd830c615beea",k);async function k({bankId:e}){try{let a=await y(),t=await a.listDocuments(u,l,[r.Query.equal("bankId",[e])]),n=t.documents;if(!t.total){let t=await a.listDocuments(u,l,[r.Query.equal("senderBankId",[e])]),c=await a.listDocuments(u,l,[r.Query.equal("receiverBankId",[e])]),d=new Map;t.documents.forEach(e=>{d.set(e.$id,e)}),c.documents.forEach(e=>{d.set(e.$id,e)}),n=Array.from(d.values())}let c=n.map(h).sort((e,a)=>new Date(a.date).getTime()-new Date(e.date).getTime());return(0,i.fM)({total:c.length,documents:c})}catch(e){console.log(e)}}let A=(0,n.j)("1708a298114feaae080ea33a4fec2f9d52e18f40",B);async function B(e){try{let a=await (0,o.getLoggedInUser)();if(!a)throw Error("You must be signed in to create a transaction");let t=await (0,o.getBank)({documentId:e.bankId});if(!t)throw Error("Bank account not found");if(t.userId!==a.$id&&t.userId?.$id!==a.$id)throw Error("You are not allowed to modify this bank account");let n=I(e.amount,e.direction),r=b(n,e.direction),d={name:e.name,amount:String(n),bankId:t.$id,userId:a.$id,senderId:a.$id,receiverId:a.$id,senderBankId:t.$id,receiverBankId:t.$id,source:"manual",direction:r,category:e.category||"Manual",date:e.date,paymentChannel:"manual",status:"posted",notes:e.notes},i=await g(d);return f.forEach(e=>(0,c.revalidatePath)(e)),i}catch(e){throw console.error("Error creating manual transaction",e),e}}let T=(0,n.j)("59faf17e5ebf2c0b0a82a283baf8f1a2a62ca763",_);async function _(e,a,t){for(let n of t){let t={name:n.name,amount:String(n.amount),bankId:e,userId:a,source:"plaid",direction:n.amount<0?"debit":"credit",category:n.category,date:n.date,paymentChannel:n.paymentChannel||"online",status:n.status||"posted",externalId:n.externalId,accountId:n.accountId};await g(t)}}(0,s.h)([g,$,A,T]),(0,n.j)("ee4dd074df4a75f7f47372a7cc3f5799b74ddcdf",g),(0,n.j)("7a45a35f90afdf1542d7c4fd1233d6e877f5bf63",$),(0,n.j)("f3fe4eb568af478701311bb556b7942edf9178fc",A),(0,n.j)("334b49ce3c6df9699bf5165fa6eb47cf477f94fa",T)},35978:(e,a,t)=>{t.d(a,{H_:()=>c,Pj:()=>r});let n=(e,a)=>{if(null==e)return a;switch(e.toLowerCase()){case"1":case"true":case"yes":case"on":return!0;case"0":case"false":case"no":case"off":return!1;default:return a}},r=()=>n("true",!0),c=()=>n("true",!0)}};
//# sourceMappingURL=17.js.map