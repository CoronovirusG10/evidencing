"use strict";(()=>{var e={};e.id=934,e.ids=[934],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},31438:e=>{e.exports=require("node-appwrite")},27790:e=>{e.exports=require("assert")},61212:e=>{e.exports=require("async_hooks")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},27920:e=>{e.exports=require("diagnostics_channel")},82266:e=>{e.exports=require("domain")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},66302:e=>{e.exports=require("inspector")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},45781:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>_,requestAsyncStorage:()=>D,routeModule:()=>k,serverHooks:()=>C,staticGenerationAsyncStorage:()=>A});var a={};r.r(a),r.d(a,{DELETE:()=>w,GET:()=>x,HEAD:()=>T,OPTIONS:()=>v,PATCH:()=>$,POST:()=>y,PUT:()=>b});var n=r(97988),o=r(7773),s=r(94049);r(19020);var i=r(23808),c=r(87394),d=r(73437),u=r(54580),l=r(41129),p=r(22470),m=r(5955),f=r(82060),h=r(2732);let I=(e,t,r)=>{let a=[e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"")||"transactions"];return t&&a.push(t),r&&a.push(r),`${a.join("-")||"transactions"}.csv`};function g(e,t){return"phase-production-build"===process.env.NEXT_PHASE||"function"!=typeof e?e:new Proxy(e,{apply:(e,r,a)=>{let n,o,s;try{let e=u.requestAsyncStorage.getStore();n=(0,i.h)((0,c.x)([e,"optionalAccess",e=>e.headers,"access",e=>e.get,"call",e=>e("sentry-trace")]),()=>void 0),o=(0,i.h)((0,c.x)([e,"optionalAccess",e=>e.headers,"access",e=>e.get,"call",e=>e("baggage")]),()=>void 0),s=(0,c.x)([e,"optionalAccess",e=>e.headers])}catch(e){}return d.z(e,{method:t,parameterizedRoute:"/api/transactions/export",sentryTraceHeader:n,baggageHeader:o,headers:s}).apply(r,a)}})}let x=g(async function(e){let t=new URL(e.url),r=t.searchParams.get("bankId"),a=t.searchParams.get("from"),n=t.searchParams.get("to"),o=t.searchParams.get("direction");if(!r)return l.NextResponse.json({error:"bankId is required"},{status:400});let s=await (0,p.getLoggedInUser)();if(!s)return l.NextResponse.json({error:"Unauthorized"},{status:401});let i=await (0,p.getBank)({documentId:r});if(!i)return l.NextResponse.json({error:"Bank not found"},{status:404});if(("string"==typeof i.userId?i.userId:i.userId?.$id)!==s.$id)return l.NextResponse.json({error:"Forbidden"},{status:403});let c=`${s.$id}:export:${r}`,d=(0,f.d)(c,{limit:5,window:6e4});if(!d.success)return console.warn("[api/export] rate limit exceeded",{userId:s.$id,bankId:r,reset:d.reset}),new l.NextResponse(JSON.stringify({error:"Too many export requests. Please try again shortly."}),{status:429,headers:{"Content-Type":"application/json","Retry-After":Math.max(Math.ceil((d.reset-Date.now())/1e3),1).toString()}});let u=await (0,m.getTransactionsByBankId)({bankId:r}),g=u?.documents??[],x=(0,h.X4)(g,{from:a,to:n,direction:o||"all"}),y=i.bankId||i.accountId||r,b=(0,h.CE)(x,{accountName:y,bankId:r,filters:{from:a,to:n,direction:o||"all"}}),$=I(y,a,n);return console.info("[api/export] generated csv",{userId:s.$id,bankId:r,remaining:d.remaining}),new l.NextResponse(b,{headers:{"Content-Type":"text/csv; charset=utf-8","Content-Disposition":`attachment; filename="${$}"`,"Cache-Control":"no-store"}})},"GET"),y=g(void 0,"POST"),b=g(void 0,"PUT"),$=g(void 0,"PATCH"),w=g(void 0,"DELETE"),T=g(void 0,"HEAD"),v=g(void 0,"OPTIONS"),k=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/transactions/export/route",pathname:"/api/transactions/export",filename:"route",bundlePath:"app/api/transactions/export/route"},resolvedPagePath:"/Users/kaveh/Horizon-bank/banking/app/api/transactions/export/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:D,staticGenerationAsyncStorage:A,serverHooks:C}=k,q="/api/transactions/export/route";function _(){return(0,s.patchFetch)({serverHooks:C,staticGenerationAsyncStorage:A})}},5955:(e,t,r)=>{r.r(t),r.d(t,{$$ACTION_0:()=>b,$$ACTION_1:()=>w,$$ACTION_2:()=>v,$$ACTION_3:()=>D,createManualTransaction:()=>T,createTransaction:()=>y,getTransactionsByBankId:()=>$,upsertPlaidTransactions:()=>k});var a=r(71577);r(90710);var n=r(31438),o=r(12712),s=r(97793),i=r(24510),c=r(22470),d=r(93205);let{APPWRITE_DATABASE_ID:u,APPWRITE_TRANSACTION_COLLECTION_ID:l}=process.env,p=["/","/transaction-history","/statements"],m=e=>Object.fromEntries(Object.entries(e).filter(([,e])=>null!=e&&""!==e)),f=(e,t)=>{let r="number"==typeof e?e:Number(e);if(Number.isNaN(r))throw Error("Invalid amount supplied for transaction");return"debit"===t?r>0?-r:r:"credit"===t?Math.abs(r):r},h=(e,t)=>t||(e<0?"debit":"credit"),I=async()=>{try{let{database:e}=await (0,s.createSessionClient)();return e}catch(t){let{database:e}=await (0,s.createAdminClient)();return e}},g=e=>{let t="number"==typeof e.amount?e.amount:Number(e.amount),r=e.direction||e.type||h(t);return{id:e.externalId||e.$id,$id:e.$id,bankId:e.bankId||e.senderBankId||e.receiverBankId,name:e.name,paymentChannel:e.paymentChannel||e.channel||"online",direction:r,type:r,accountId:e.accountId,amount:Number.isNaN(t)?0:t,pending:e.status?"posted"!==e.status:e.pending,category:e.category||"Transfer",date:e.date||e.$createdAt,image:e.image,status:e.status||(e.pending?"pending":"posted"),source:e.source,externalId:e.externalId,notes:e.notes,$createdAt:e.$createdAt,channel:e.channel,senderBankId:e.senderBankId,receiverBankId:e.receiverBankId}},x=async e=>{let{database:t}=await (0,s.createAdminClient)(),r=e.externalId;if(r){let a=await t.listDocuments(u,l,[n.Query.equal("externalId",[r])]);if(a.total>0){let r=a.documents[0],n=await t.updateDocument(u,l,r.$id,m(e));return(0,i.fM)(n)}}let a=await t.createDocument(u,l,n.ID.unique(),m(e));return(0,i.fM)(a)},y=(0,a.j)("80a709ce214cb135ebc8fe86370fa62d696d6912",b);async function b(e){try{let t=f(e.amount,e.direction),r=h(t,e.direction),a=e.bankId||e.senderBankId||e.receiverBankId,n=m({name:e.name,amount:t,direction:r,type:r,category:e.category||"Transfer",paymentChannel:e.paymentChannel||e.channel||"online",channel:e.channel||e.paymentChannel||"online",status:e.status||"posted",source:e.source||"transfer",date:e.date||new Date().toISOString(),bankId:a,accountId:e.accountId,senderId:e.senderId,receiverId:e.receiverId,senderBankId:e.senderBankId||a,receiverBankId:e.receiverBankId||a,email:e.email,userId:e.userId,externalId:e.externalId,notes:e.notes,metadata:e.metadata});return await x(n)}catch(e){throw console.log(e),e}}let $=(0,a.j)("caff1ac64ec0acb8c5e38bfb005fd830c615beea",w);async function w({bankId:e}){try{let t=await I(),r=await t.listDocuments(u,l,[n.Query.equal("bankId",[e])]),a=r.documents;if(!r.total){let r=await t.listDocuments(u,l,[n.Query.equal("senderBankId",[e])]),o=await t.listDocuments(u,l,[n.Query.equal("receiverBankId",[e])]),s=new Map;r.documents.forEach(e=>{s.set(e.$id,e)}),o.documents.forEach(e=>{s.set(e.$id,e)}),a=Array.from(s.values())}let o=a.map(g).sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime());return(0,i.fM)({total:o.length,documents:o})}catch(e){console.log(e)}}let T=(0,a.j)("1708a298114feaae080ea33a4fec2f9d52e18f40",v);async function v(e){try{let t=await (0,c.getLoggedInUser)();if(!t)throw Error("You must be signed in to create a transaction");let r=await (0,c.getBank)({documentId:e.bankId});if(!r)throw Error("Bank account not found");if(r.userId!==t.$id&&r.userId?.$id!==t.$id)throw Error("You are not allowed to modify this bank account");let a=f(e.amount,e.direction),n=h(a,e.direction),s={name:e.name,amount:String(a),bankId:r.$id,userId:t.$id,senderId:t.$id,receiverId:t.$id,senderBankId:r.$id,receiverBankId:r.$id,source:"manual",direction:n,category:e.category||"Manual",date:e.date,paymentChannel:"manual",status:"posted",notes:e.notes},i=await y(s);return p.forEach(e=>(0,o.revalidatePath)(e)),i}catch(e){throw console.error("Error creating manual transaction",e),e}}let k=(0,a.j)("59faf17e5ebf2c0b0a82a283baf8f1a2a62ca763",D);async function D(e,t,r){for(let a of r){let r={name:a.name,amount:String(a.amount),bankId:e,userId:t,source:"plaid",direction:a.amount<0?"debit":"credit",category:a.category,date:a.date,paymentChannel:a.paymentChannel||"online",status:a.status||"posted",externalId:a.externalId,accountId:a.accountId};await y(r)}}(0,d.h)([y,$,T,k]),(0,a.j)("ee4dd074df4a75f7f47372a7cc3f5799b74ddcdf",y),(0,a.j)("7a45a35f90afdf1542d7c4fd1233d6e877f5bf63",$),(0,a.j)("f3fe4eb568af478701311bb556b7942edf9178fc",T),(0,a.j)("334b49ce3c6df9699bf5165fa6eb47cf477f94fa",k)},82060:(e,t,r)=>{r.d(t,{d:()=>o});let a={limit:5,window:6e4},n=()=>{let e=globalThis;return e.__HORIZON_RATE_LIMIT__||(e.__HORIZON_RATE_LIMIT__=new Map),e.__HORIZON_RATE_LIMIT__},o=(e,t=a)=>{let r=n(),o=Date.now(),s=r.get(e);if(s&&o<s.reset){if(s.count>=t.limit)return{success:!1,remaining:0,reset:s.reset};let a=s.count+1;return r.set(e,{count:a,reset:s.reset}),{success:!0,remaining:Math.max(t.limit-a,0),reset:s.reset}}let i=o+t.window;return r.set(e,{count:1,reset:i}),{success:!0,remaining:t.limit-1,reset:i}}},2732:(e,t,r)=>{r.d(t,{CE:()=>c,I_:()=>s,P_:()=>d,X4:()=>o});let a=e=>(e instanceof Date?e:new Date(e)).toISOString().slice(0,10),n=e=>{let t=e instanceof Date?e:new Date(e);return new Date(t.getFullYear(),t.getMonth(),t.getDate())},o=(e,t)=>{if(!e?.length)return[];let{from:r,to:a,direction:o}=t,s=r?n(r):null,i=a?n(a):null,c=o&&"all"!==o?o:null;return e.filter(e=>{let t=n(e.date);return(!s||!(t<s))&&(!i||!(t>i))&&(!c||(e.direction||e.type)===c)})},s=(e,t)=>{let r=e.reduce((e,t)=>e+t.amount,0);return{totalCredits:e.filter(e=>e.amount>0).reduce((e,t)=>e+t.amount,0),totalDebits:e.filter(e=>e.amount<0).reduce((e,t)=>e+Math.abs(t.amount),0),netChange:r,openingBalance:t-r,closingBalance:t}},i=e=>{if(null==e)return"";let t=String(e);return/[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t},c=(e,t)=>{let{accountName:r,bankId:n,filters:o}=t,s=[["Account",r],["Bank ID",n],["From",o.from?a(o.from):"—"],["To",o.to?a(o.to):"—"],["Direction",o.direction&&"all"!==o.direction?o.direction:"All"],[]],c=e.map(e=>[a(e.date),e.name,e.amount.toFixed(2),e.direction||e.type||"",e.category||"",e.paymentChannel||e.channel||"",e.source||""]);return[...s.map(e=>e.map(i).join(",")),"Date,Description,Amount,Direction,Category,Payment Channel,Source",...c.map(e=>e.map(i).join(","))].join("\n")},d=(e,t,r)=>{let{accountName:n,officialName:o,period:s,direction:i}=r,c=[];return c.push(`Account: ${n}`),o&&c.push(`Institution: ${o}`),c.push(`Statement Period: ${a(s.from)} to ${a(s.to)}`),i&&"all"!==i&&c.push(`Direction: ${i}`),c.push(`Opening Balance: $${t.openingBalance.toFixed(2)}`),c.push(`Closing Balance: $${t.closingBalance.toFixed(2)}`),c.push(`Total Credits: $${t.totalCredits.toFixed(2)}`),c.push(`Total Debits: $${t.totalDebits.toFixed(2)}`),c.push(""),c.push("Date | Description | Amount | Direction | Category"),e.forEach(e=>{let t=a(e.date),r=e.amount.toFixed(2),n=e.direction||e.type||"",o=e.category||"";c.push(`${t} | ${e.name} | ${r} | ${n} | ${o}`)}),c}},43168:(e,t,r)=>{e.exports=r(24636).vendored["react-rsc"].ReactDOM},3757:(e,t,r)=>{e.exports=r(24636).vendored["react-rsc"].ReactServerDOMWebpackServerEdge}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[50,403,819,593],()=>r(45781));module.exports=a})();
//# sourceMappingURL=route.js.map