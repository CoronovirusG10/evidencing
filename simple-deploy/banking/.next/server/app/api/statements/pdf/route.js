"use strict";(()=>{var e={};e.id=122,e.ids=[122],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},31438:e=>{e.exports=require("node-appwrite")},27790:e=>{e.exports=require("assert")},61212:e=>{e.exports=require("async_hooks")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},27920:e=>{e.exports=require("diagnostics_channel")},82266:e=>{e.exports=require("domain")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},66302:e=>{e.exports=require("inspector")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},49:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>C,patchFetch:()=>S,requestAsyncStorage:()=>w,routeModule:()=>_,serverHooks:()=>A,staticGenerationAsyncStorage:()=>E});var n={};r.r(n),r.d(n,{DELETE:()=>D,GET:()=>q,HEAD:()=>R,OPTIONS:()=>I,PATCH:()=>P,POST:()=>v,PUT:()=>j});var s=r(97988),a=r(7773),o=r(94049);r(19020);var i=r(23808),u=r(87394),l=r(73437),p=r(54580),c=r(41129),d=r(5017),h=r(22470);let m=e=>e.replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)");class g{reserve(){return this.objects.push(""),this.objects.length-1}add(e){return this.objects.push(e),this.objects.length-1}set(e,t){this.objects[e]=t}build(e){let t="%PDF-1.4\n",r=[t],n=[0],s=Buffer.byteLength(t,"utf8");for(let e=1;e<this.objects.length;e+=1){n[e]=s;let t=`${e} 0 obj
${this.objects[e]}
endobj
`;r.push(t),s+=Buffer.byteLength(t,"utf8")}let a=s,o=this.objects.length-1,i=["xref",`0 ${o+1}`,"0000000000 65535 f "];for(let e=1;e<=o;e+=1)i.push(`${n[e].toString().padStart(10,"0")} 00000 n `);let u=`${i.join("\n")}
`,l=`trailer
<< /Size ${o+1} /Root ${e} 0 R >>
startxref
${a}
%%EOF`;return r.push(u,l),Buffer.from(r.join(""))}constructor(){this.objects=[""]}}let f=e=>{let t="BT\n/F1 12 Tf\n";return e.forEach((e,r)=>{t+=`1 0 0 1 50 ${800-16*r} Tm (${m(e)}) Tj
`}),t+="ET"},x=(e,t)=>{let r=[];for(let n=0;n<e.length;n+=t)r.push(e.slice(n,n+t));return r},$=({lines:e})=>{let t=new g,r=t.reserve(),n=t.reserve(),s=t.add("<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>"),a=x(e.length?e:["No transactions for this statement period."],44),o=[],i=[];a.forEach(e=>{let r=f(e),n=`<< /Length ${Buffer.byteLength(r,"utf8")} >>
stream
${r}
endstream`,s=t.add(n),a=t.reserve();o.push(a),i.push(s)}),o.forEach((e,r)=>{let a=i[r],o=`<< /Type /Page /Parent ${n} 0 R /MediaBox [0 0 595 842] /Resources << /Font << /F1 ${s} 0 R >> >> /Contents ${a} 0 R >>`;t.set(e,o)});let u=o.map(e=>`${e} 0 R`).join(" ");return t.set(n,`<< /Type /Pages /Kids [${u}] /Count ${o.length} >>`),t.set(r,`<< /Type /Catalog /Pages ${n} 0 R >>`),t.build(r)};var y=r(82060),T=r(2732);function b(e,t){return"phase-production-build"===process.env.NEXT_PHASE||"function"!=typeof e?e:new Proxy(e,{apply:(e,r,n)=>{let s,a,o;try{let e=p.requestAsyncStorage.getStore();s=(0,i.h)((0,u.x)([e,"optionalAccess",e=>e.headers,"access",e=>e.get,"call",e=>e("sentry-trace")]),()=>void 0),a=(0,i.h)((0,u.x)([e,"optionalAccess",e=>e.headers,"access",e=>e.get,"call",e=>e("baggage")]),()=>void 0),o=(0,u.x)([e,"optionalAccess",e=>e.headers])}catch(e){}return l.z(e,{method:t,parameterizedRoute:"/api/statements/pdf",sentryTraceHeader:s,baggageHeader:a,headers:o}).apply(r,n)}})}let q=b(async function(e){let t=new URL(e.url),r=t.searchParams.get("bankId"),n=t.searchParams.get("from"),s=t.searchParams.get("to"),a=t.searchParams.get("direction");if(!r||!n||!s)return c.NextResponse.json({error:"bankId, from, and to parameters are required"},{status:400});let o=await (0,h.getLoggedInUser)();if(!o)return c.NextResponse.json({error:"Unauthorized"},{status:401});let i=await (0,h.getBank)({documentId:r});if(!i)return c.NextResponse.json({error:"Bank not found"},{status:404});if(("string"==typeof i.userId?i.userId:i.userId?.$id)!==o.$id)return c.NextResponse.json({error:"Forbidden"},{status:403});let u=await (0,d.getAccount)({appwriteItemId:r}),l=u?.transactions||[],p=`${o.$id}:statement:${r}`,m=(0,y.d)(p,{limit:5,window:6e4});if(!m.success)return console.warn("[api/statements/pdf] rate limit exceeded",{userId:o.$id,bankId:r,reset:m.reset}),c.NextResponse.json({error:"Too many statement requests. Please try again shortly."},{status:429,headers:{"Retry-After":Math.max(Math.ceil((m.reset-Date.now())/1e3),1).toString()}});let g=(0,T.X4)(l,{from:n,to:s,direction:a||"all"}),f=(0,T.I_)(g,u?.data?.currentBalance||0),x=$({lines:(0,T.P_)(g,f,{accountName:u?.data?.name||r,officialName:u?.data?.officialName,period:{from:n,to:s},direction:a||"all"})}),b=[(u?.data?.name||"statement").toLowerCase().replace(/[^a-z0-9]+/g,"-"),n,s];a&&"all"!==a&&b.push(a);let q=`${b.filter(Boolean).join("-")}.pdf`;return console.info("[api/statements/pdf] generated statement",{userId:o.$id,bankId:r,from:n,to:s,remaining:m.remaining}),new c.NextResponse(x,{headers:{"Content-Type":"application/pdf","Content-Disposition":`attachment; filename="${q}"`,"Cache-Control":"no-store"}})},"GET"),v=b(void 0,"POST"),j=b(void 0,"PUT"),P=b(void 0,"PATCH"),D=b(void 0,"DELETE"),R=b(void 0,"HEAD"),I=b(void 0,"OPTIONS"),_=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/statements/pdf/route",pathname:"/api/statements/pdf",filename:"route",bundlePath:"app/api/statements/pdf/route"},resolvedPagePath:"/Users/kaveh/Horizon-bank/banking/app/api/statements/pdf/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:w,staticGenerationAsyncStorage:E,serverHooks:A}=_,C="/api/statements/pdf/route";function S(){return(0,o.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:E})}},82060:(e,t,r)=>{r.d(t,{d:()=>a});let n={limit:5,window:6e4},s=()=>{let e=globalThis;return e.__HORIZON_RATE_LIMIT__||(e.__HORIZON_RATE_LIMIT__=new Map),e.__HORIZON_RATE_LIMIT__},a=(e,t=n)=>{let r=s(),a=Date.now(),o=r.get(e);if(o&&a<o.reset){if(o.count>=t.limit)return{success:!1,remaining:0,reset:o.reset};let n=o.count+1;return r.set(e,{count:n,reset:o.reset}),{success:!0,remaining:Math.max(t.limit-n,0),reset:o.reset}}let i=a+t.window;return r.set(e,{count:1,reset:i}),{success:!0,remaining:t.limit-1,reset:i}}},2732:(e,t,r)=>{r.d(t,{CE:()=>u,I_:()=>o,P_:()=>l,X4:()=>a});let n=e=>(e instanceof Date?e:new Date(e)).toISOString().slice(0,10),s=e=>{let t=e instanceof Date?e:new Date(e);return new Date(t.getFullYear(),t.getMonth(),t.getDate())},a=(e,t)=>{if(!e?.length)return[];let{from:r,to:n,direction:a}=t,o=r?s(r):null,i=n?s(n):null,u=a&&"all"!==a?a:null;return e.filter(e=>{let t=s(e.date);return(!o||!(t<o))&&(!i||!(t>i))&&(!u||(e.direction||e.type)===u)})},o=(e,t)=>{let r=e.reduce((e,t)=>e+t.amount,0);return{totalCredits:e.filter(e=>e.amount>0).reduce((e,t)=>e+t.amount,0),totalDebits:e.filter(e=>e.amount<0).reduce((e,t)=>e+Math.abs(t.amount),0),netChange:r,openingBalance:t-r,closingBalance:t}},i=e=>{if(null==e)return"";let t=String(e);return/[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t},u=(e,t)=>{let{accountName:r,bankId:s,filters:a}=t,o=[["Account",r],["Bank ID",s],["From",a.from?n(a.from):"—"],["To",a.to?n(a.to):"—"],["Direction",a.direction&&"all"!==a.direction?a.direction:"All"],[]],u=e.map(e=>[n(e.date),e.name,e.amount.toFixed(2),e.direction||e.type||"",e.category||"",e.paymentChannel||e.channel||"",e.source||""]);return[...o.map(e=>e.map(i).join(",")),"Date,Description,Amount,Direction,Category,Payment Channel,Source",...u.map(e=>e.map(i).join(","))].join("\n")},l=(e,t,r)=>{let{accountName:s,officialName:a,period:o,direction:i}=r,u=[];return u.push(`Account: ${s}`),a&&u.push(`Institution: ${a}`),u.push(`Statement Period: ${n(o.from)} to ${n(o.to)}`),i&&"all"!==i&&u.push(`Direction: ${i}`),u.push(`Opening Balance: $${t.openingBalance.toFixed(2)}`),u.push(`Closing Balance: $${t.closingBalance.toFixed(2)}`),u.push(`Total Credits: $${t.totalCredits.toFixed(2)}`),u.push(`Total Debits: $${t.totalDebits.toFixed(2)}`),u.push(""),u.push("Date | Description | Amount | Direction | Category"),e.forEach(e=>{let t=n(e.date),r=e.amount.toFixed(2),s=e.direction||e.type||"",a=e.category||"";u.push(`${t} | ${e.name} | ${r} | ${s} | ${a}`)}),u}},43168:(e,t,r)=>{e.exports=r(24636).vendored["react-rsc"].ReactDOM},3757:(e,t,r)=>{e.exports=r(24636).vendored["react-rsc"].ReactServerDOMWebpackServerEdge}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[50,403,819,593,17],()=>r(49));module.exports=n})();
//# sourceMappingURL=route.js.map